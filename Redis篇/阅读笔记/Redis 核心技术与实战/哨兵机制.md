# 哨兵机制

当主库故障后，从库无法服务写操作，无论是写服务中断，还是从库无法进行数据同步，都是不能接受的。所以，如果主库挂了，就需要运行一个新主库，比如说把一个从库切换为主库，把它当成主库。这就涉及到三个问题：
1. 主库真的挂了吗？【问题一】
2. 该选择哪个从库作为主库？【问题二】
3. 怎么把新主库的相关信息通知给从库和客户端呢？【问题三】

![主库挂了示意图](.pic/2023-02-19-%E4%B8%BB%E5%BA%93%E6%8C%82%E4%BA%86%E7%A4%BA%E6%84%8F%E5%9B%BE.png)

在 `Redis` 主从集群中，哨兵机制是实现<font color="red">主从库自动切换的关键机制</font>，它有效地解决了主从复制模式下故障转移的这三个问题。

## 哨兵机制的基本流程
哨兵其实就是一个运行在<font color="red">特殊模式下的 `Redis` 进程</font>，主从库实例运行的同时，它也在运行。哨兵主要负责的就是三个任务：<font color="red">监控、选主（选择主库）和通知</font>。

1. 监控：
   - 监控是指哨兵进程在运行时，<font color="red">周期性地</font>给所有的主从库发送 `PING` 命令，检测它们是否仍然在线运行。如果从库没有在<font color="red">规定时间内</font>响应哨兵的 `PING` 命令，哨兵就会把它标记为“下线状态”；同样，如果主库也没有在<font color="red">规定时间内</font>响应哨兵的 `PING` 命令，哨兵就会判定主库下线

2. 选主：
   - 主库挂了以后，哨兵就需要从很多个从库里，按照<font color="red">一定的规则</font>选择一个从库实例，把它作为新的主库。

3. 通知：
   - 在执行通知任务时，哨兵会把新主库的连接信息发给其他从库，让它们执行 `replicaof` 命令，和新主库<font color="red">建立连接</font>，并进行<font color="red">数据复制</font>。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。

![三个任务以及各自的目标](.pic/2023-02-19-%E4%B8%89%E4%B8%AA%E4%BB%BB%E5%8A%A1%E4%BB%A5%E5%8F%8A%E5%90%84%E8%87%AA%E7%9A%84%E7%9B%AE%E6%A0%87.png)

### 主观/客观下线（监控任务）【问题一】
哨兵对主库的下线判断有“主观下线”和“客观下线”两种：
- “主观下线”：哨兵进程会使用 `PING` 命令检测它自己和主、从库的<font color="red">网络连接情况</font>，用来判断实例的状态。如果哨兵发现主库或从库对 `PING` 命令的<font color="red">响应超时</font>了，那么，哨兵就会先把它标记为“主观下线”。
  - 如果检测的是从库，那么，哨兵简单地把它标记为“主观下线”就行了，因为<font color="red">从库的下线影响一般不太大</font>，集群的对外服务不会间断。
  - 如果检测的是主库，那么，哨兵还不能简单地把它标记为“主观下线”，因为存在着一个<font color="red">“误判”</font>的情况。


- “客观下线”：当有 `N` 个哨兵实例时，最好要有 <font color="red">N/2 + 1</font> 个实例判断主库为“主观下线”，才能最终判定主库为“客观下线”（可以减少误判的概率，也能避免误判带来的无谓的主从库切换，有多少个实例做出“主观下线”的判断才可以，可以由 `Redis` 管理员自行设定）。

#### 主观下线误判？
**什么叫误判？**

- 就是主库实际并没有下线，但是哨兵误以为它下线了。误判一般会发生在<font color="red">集群网络压力较大、网络拥塞，或者是主库本身压力较大</font>的情况下。

**如何减少误判？**

- 引入多个哨兵实例（哨兵集群）一起来判断，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。


### 如何选定新主库（选主任务）？【问题二】

哨兵选择新主库的过程称为“筛选 + 打分”：在多个从库中，先按照<font color="red">一定的筛选条件</font>，把不符合条件的从库去掉。然后，我们再按照<font color="red">一定的规则</font>，给剩下的从库逐个打分，将得分最高的从库选为新主库。

![新主库选择过程](.pic/2023-02-19-%E6%96%B0%E4%B8%BB%E5%BA%93%E9%80%89%E6%8B%A9%E8%BF%87%E7%A8%8B.png)

上面说到了两个“一定”，这里解释一下具体是指什么：
- 一定的筛选条件：（除了要检查从库的<font color="red">当前在线状态</font>，还要判断它<font color="red">之前的网络连接状态</font>。）
  - 具体怎么判断呢？使用配置项 `down-after-milliseconds` * 10。其中，`down-after-milliseconds` 是我们认定<font color="red">主从库断连的最大连接超时时间</font>。如果在 `down-after-milliseconds `毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果<font color="red">发生断连的次数超过了 `10` 次</font>，就说明这个从库的网络状况不好，不适合作为新主库。



- 一定的打分规则：（分三轮）
  - 第一轮：<font color="red">优先级最高的从库得分高</font>。
    - 用户可以通过 `slave-priority `配置项，给不同的从库设置不同优先级。
  - 第二轮：<font color="red">和旧主库同步程度最接近的从库得分高</font>。
    - 在所有从库中，有从库的 `slave_repl_offset` 最接近 `master_repl_offset` ，那么它的得分就最高，可以作为新主库。
  - 第三轮：<font color="red">`ID号小的从库得分高</font>。
    - 目前， `Redis` 在选主库时，有一个<font color="red">默认的规定</font>：在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库。

### 通知任务【问题三】
通知任务相对来说比较简单，哨兵只需要把新主库信息发给从库和客户端，让它们和新主库建立连接就行，并不涉及决策的逻辑。