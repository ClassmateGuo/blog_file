# 哨兵集群

##  基于 pub/sub 机制的哨兵集群组成

在主从集群中，主库上有一个名为`“sentinel:hello”`的频道，不同哨兵就是通过它来相互发现，实现@1互相通信@2的。

**举个例子，具体说明一下：**

在下图中，哨兵 1 把自己的 IP（172.16.19.3）和端口（26579）发布到“sentinel:hello”频道上，哨兵 2 和 3 订阅了该频道。那么此时，哨兵 2 和 3 就可以从这个频道直接获取哨兵 1 的 IP 地址和端口号。

然后，哨兵 2、3 可以和哨兵 1 建立网络连接。通过这个方式，哨兵 2 和 3 也可以建立网络连接，这样一来，哨兵集群就形成了。它们相互间可以通过网络连接进行通信，比如说对主库有没有下线这件事儿进行判断和协商。

![哨兵通信连接](.pic/2023-02-20-%E5%93%A8%E5%85%B5%E9%80%9A%E4%BF%A1%E8%BF%9E%E6%8E%A5.png)

哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为，在哨兵的监控任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后，它还需要通知从库，让它们和新主库进行同步。

**哨兵向主库发送 `INFO` 命令来完成的：**
![获取从库信息](.pic/2023-02-20-%E8%8E%B7%E5%8F%96%E4%BB%8E%E5%BA%93%E4%BF%A1%E6%81%AF.png)

通过 `pub/sub` 机制，哨兵之间可以@1组成集群@2，同时，哨兵又通过 `INFO` 命令，@1获得了从库连接信息@2，也能和从库建立连接，并进行监控了。

## 基于 pub/sub 机制的客户端事件通知

从本质上说，哨兵就是一个运行在特定模式下的 `Redis` 实例，只不过它并不服务请求操作，只是完成监控、选主和通知的任务。所以，每个哨兵实例也提供 `pub/sub` 机制，客户端可以从哨兵订阅消息。哨兵提供的消息订阅频道有很多，不同频道包含了主从库切换过程中的不同关键事件。

![客户端通知事件](.pic/2023-02-20-%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E7%9F%A5%E4%BA%8B%E4%BB%B6.png)

**知道了频道之后，就可以让客户端从哨兵这里订阅消息了。**


具体的操作步骤是，客户端读取哨兵的配置文件后，可以获得哨兵的地址和端口，和哨兵建立网络连接。然后，可以在客户端执行订阅命令，来获取不同的事件消息。

例如：
- 订阅“所有实例进入客观下线状态的事件”：`SUBSCRIBE +odown`
- 订阅所有的事件：`PSUBSCRIBE  *`

当哨兵把新主库选择出来后，客户端就会看到下面的 `switch-master` 事件。这个事件表示主库已经切换了，新主库的 `IP` 地址和端口信息已经有了。这个时候，客户端就可以用这里面的新主库地址和端口进行通信了。
```
switch-master <master name> <oldip> <oldport> <newip> <newport>
```